<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 20 Stock Screener</title>
    <!-- Load Tailwind CSS via CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Apply smooth scrolling and set the font */
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    </style>
    
    <!-- Load React and ReactDOM Libraries (Loaded via CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Load Charting Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    
    <!-- FINAL FIX: Use compatible Firebase SDK V8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
</head>
<body>
    <div id="root"></div>
    
    <!-- Consolidated React Application Code (Pure JS/createElement syntax) -->
    <script>
        // Global variables required by the component (as established in the pipeline)
        window.__app_id = 'default-app-id';
        window.__firebase_config = JSON.stringify({}); 

        // =========================================================================
        // START: Firebase and React Setup - CORE LOGIC DEFINITIONS
        // =========================================================================

        const { useState, useEffect, useRef, useCallback, createElement } = React;
        const Chart = window.Chart;
        
        // --- Configuration ---
        const appId = window.__app_id;
        const firebaseConfig = JSON.parse(window.__firebase_config);
        const initialAuthToken = window.__initial_auth_token;

        // IMPORTANT: This key must be set manually on the client side.
        const CHART_API_KEY = "YOUR_CHART_API_KEY_HERE"; 
        const FINANCIAL_API_BASE_URL = "https://www.alphavantage.co/query"; 


        // --- Helper to get modern Firebase functions (V8 compatible) ---
        const getFirebaseModules = () => {
            // Since we load V8, we can use the global firebase object directly.
            if (!window.firebase) {
                console.error("Firebase object not defined. Check CDN loading.");
                return {
                    initializeApp: () => ({}), getAuth: () => ({}), signInAnonymously: () => ({}), 
                    signInWithCustomToken: () => ({}), onAuthStateChanged: () => ({}), 
                    getFirestore: () => ({}), collection: () => ({}), onSnapshot: () => ({}), 
                    query: () => ({}), 
                };
            }
            
            // Accessing global objects defined by the CDN (V8 syntax)
            return {
                initializeApp: window.firebase.initializeApp,
                getAuth: window.firebase.auth, 
                signInAnonymously: window.firebase.auth().signInAnonymously,
                signInWithCustomToken: window.firebase.auth().signInWithCustomToken,
                onAuthStateChanged: window.firebase.auth().onAuthStateChanged,
                getFirestore: window.firebase.firestore, 
                collection: window.firebase.firestore().collection,
                onSnapshot: window.firebase.firestore().onSnapshot,
                query: window.firebase.firestore().query,
            };
        };

        // --- INLINE SVG ICON COMPONENTS (Pure JS) ---
        const Icon = ({ name, size = 24, className }) => {
            let svgContent = '';
            let viewBox = '0 0 24 24';

            switch (name) {
                case 'dollar-sign': 
                    svgContent = '<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>'; 
                    break;
                case 'log-in':
                    svgContent = '<path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line>';
                    break;
                case 'trending-up':
                    svgContent = '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>';
                    break;
                case 'x':
                    svgContent = '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>';
                    break;
                default: 
                    return createElement('span', { className: className }, '?');
            }

            return createElement('svg', {
                className: className,
                width: size,
                height: size,
                viewBox: viewBox,
                fill: "none",
                stroke: "currentColor",
                strokeWidth: 2,
                strokeLinecap: "round",
                strokeLinejoin: "round",
                dangerouslySetInnerHTML: { __html: svgContent }
            });
        };

        const LogInIcon = (props) => createElement(Icon, { name: 'log-in', ...props });
        const TrendingUpIcon = (props) => createElement(Icon, { name: 'trending-up', ...props });
        const DollarSignIcon = (props) => createElement(Icon, { name: 'dollar-sign', ...props });
        const XIcon = (props) => createElement(Icon, { name: 'x', ...props });


        // --- APP COMPONENT ---

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [topStocks, setTopStocks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [chartData, setChartData] = useState(null);
            const [modalPos, setModalPos] = useState({ x: 50, y: 50 });
            const modalRef = useRef(null);
            

            // 1. Firebase Initialization and Authentication
            useEffect(() => {
                const modules = getFirebaseModules();
                
                try {
                    if (window.firebase) {
                       window.firebase.firestore().setLogLevel('debug'); 
                    }
                    
                    const app = modules.initializeApp(firebaseConfig);
                    const firestore = modules.getFirestore(app);
                    const firebaseAuth = modules.getAuth(app);
                    
                    const signIn = async () => {
                        try {
                            if (initialAuthToken) {
                                await modules.signInWithCustomToken(firebaseAuth, initialAuthToken);
                            } else {
                                await modules.signInAnonymously(firebaseAuth);
                            }
                        } catch (e) {
                            console.error("Firebase sign-in failed:", e);
                            setError("Authentication failed. Check console for details.");
                        }
                    };
                    
                    signIn().then(() => {
                        modules.onAuthStateChanged(firebaseAuth, (user) => {
                            setAuth(firebaseAuth);
                            setDb(firestore);
                            setUserId(user ? user.uid : null);
                            setIsAuthReady(true);
                            setLoading(false);
                        });
                    });

                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    setError("Failed to initialize Firebase. Check console.");
                    setLoading(false);
                }
            }, []);

            // 2. Real-time Firestore Listener for Top Stocks
            useEffect(() => {
                if (!isAuthReady || !db) return;

                const { collection, onSnapshot, query } = getFirebaseModules();

                const collectionPath = `artifacts/${appId}/public/data/topStocks`;
                const q = query(collection(db, collectionPath));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const stocks = [];
                    snapshot.forEach((doc) => {
                        stocks.push({ id: doc.id, ...doc.data() });
                    });
                    stocks.sort((a, b) => (b.score || 0) - (a.score || 0));
                    setTopStocks(stocks);
                    if (loading) setLoading(false);
                }, (err) => {
                    console.error("Firestore data snapshot error:", err);
                    setError("Could not load stock data.");
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [isAuthReady, db]);

            // 3. Data Fetching Function for Charting (Exponential Backoff included)
            const fetchStockData = useCallback(async (symbol) => {
                if (!CHART_API_KEY || CHART_API_KEY === "YOUR_CHART_API_KEY_HERE") {
                    setError("Please set a valid CHART_API_KEY to fetch chart data.");
                    return;
                }

                const url = `${FINANCIAL_API_BASE_URL}?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${symbol}&apikey=${CHART_API_KEY}`;
                const MAX_RETRIES = 5;
                let attempt = 0;
                
                setChartData({ symbol, data: [], loading: true }); 

                while (attempt < MAX_RETRIES) {
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const data = await response.json();
                        
                        if (data["Error Message"] || data["Note"]) {
                            throw new Error(data["Error Message"] || data["Note"] || "API returned an error or limit warning. Check your API key and rate limits.");
                        }
                        
                        const timeSeries = data["Time Series (Daily)"];
                        if (!timeSeries) {
                            throw new Error("Invalid data structure received from API. Check if the symbol is correct.");
                        }

                        const dates = Object.keys(timeSeries).sort();
                        const chartPoints = dates.map(date => ({
                            x: date,
                            y: parseFloat(timeSeries[date]["4. close"])
                        }));

                        setChartData({ symbol, data: chartPoints, loading: false });
                        return; 
                        
                    } catch (e) {
                        console.warn(`Attempt {attempt + 1} failed for {symbol}: {e.message}`);
                        setChartData({ symbol, data: [], loading: false, error: e.message });
                        attempt++;
                        if (attempt >= MAX_RETRIES) {
                            setError(`Failed to fetch historical data for {symbol} after {MAX_RETRIES} attempts. Error: {e.message}`);
                            break;
                        }
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }, []);

            // 4. Movable Chart Modal Logic
            const ChartModal = ({ data, onClose }) => {
                const canvasRef = useRef(null);
                const [isDragging, setIsDragging] = useState(false);
                const dragStartPos = useRef({ x: 0, y: 0 });
                const chartInstance = useRef(null);

                // Chart Rendering Logic
                useEffect(() => {
                    if (canvasRef.current && data && data.data.length > 0) {
                        if (chartInstance.current) {
                            chartInstance.current.destroy(); 
                        }

                        const ctx = canvasRef.current.getContext('2d');
                        const moment = window.moment; 
                        
                        chartInstance.current = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: [{
                                    label: `${data.symbol} Daily Close Price`,
                                    data: data.data,
                                    parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1,
                                    pointRadius: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: true },
                                    title: { display: true, text: `${data.symbol} Historical Performance`, font: { size: 16 } }
                                },
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: { unit: 'day', tooltipFormat: 'MMM D, YYYY' },
                                        title: { display: true, text: 'Date' }
                                    },
                                    y: { 
                                        title: { display: true, text: 'Price ($)' },
                                        ticks: {
                                            callback: function(value, index, ticks) {
                                                return '$' + value;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    return () => {
                        if (chartInstance.current) {
                            chartInstance.current.destroy();
                        }
                    };
                }, [data]);


                // Drag Handler Logic
                const handleMouseDown = (e) => {
                    if (e.target.closest('.drag-handle')) {
                        setIsDragging(true);
                        dragStartPos.current = {
                            x: e.clientX - modalPos.x,
                            y: e.clientY - modalPos.y,
                        };
                    }
                };

                const handleMouseMove = useCallback((e) => {
                    if (!isDragging) return;
                    let newX = e.clientX - dragStartPos.current.x;
                    let newY = e.clientY - dragStartPos.current.y; 
                    
                    const bounds = modalRef.current.getBoundingClientRect();
                    const maxX = window.innerWidth - bounds.width;
                    const maxY = window.innerHeight - bounds.height;
                    
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));

                    setModalPos({ x: newX, y: newY });
                }, [isDragging]);

                const handleMouseUp = useCallback(() => {
                    setIsDragging(false);
                }, []);

                useEffect(() => {
                    if (isDragging) {
                        window.addEventListener('mousemove', handleMouseMove);
                        window.addEventListener('mouseup', handleMouseUp);
                    } else {
                        window.removeEventListener('mousemove', handleMouseMove);
                        window.removeEventListener('mouseup', handleMouseUp);
                    }
                    return () => {
                        window.removeEventListener('mousemove', handleMouseMove);
                        window.removeEventListener('mouseup', handleMouseUp);
                    };
                }, [isDragging, handleMouseMove, handleMouseUp]);


                return (
                    createElement('div', { 
                        ref: modalRef,
                        className: "fixed bg-white/95 backdrop-blur-sm shadow-2xl rounded-xl z-50 border border-gray-200 w-11/12 md:w-3/4 lg:w-2/3 max-w-4xl transition-shadow",
                        style: { top: `${modalPos.y}px`, left: `${modalPos.x}px`, cursor: isDragging ? 'grabbing' : 'default' }
                    },
                        createElement('div', { 
                            className: "drag-handle p-3 bg-indigo-600 text-white flex justify-between items-center rounded-t-xl cursor-grab active:cursor-grabbing",
                            onMouseDown: handleMouseDown
                        },
                            createElement('h3', { className: "text-lg font-bold" }, `Chart: ${data.symbol}`),
                            createElement('button', { 
                                onClick: onClose, 
                                className: "p-1 rounded-full hover:bg-indigo-700 transition-colors",
                                title: "Close Chart"
                            },
                                createElement(XIcon, { size: 20 })
                            )
                        ),
                        createElement('div', { className: "p-4 h-96 flex items-center justify-center" },
                            data.loading && (
                                createElement('div', { className: "text-indigo-600 animate-spin mr-3" },
                                    createElement(TrendingUpIcon, { size: 32 })
                                )
                            ),
                            data.error && (
                                createElement('div', { className: "text-red-500 text-center p-4" },
                                    createElement('p', { className: "font-bold" }, "Data Fetch Error"),
                                    createElement('p', { className: "text-sm" }, data.error),
                                    createElement('p', { className: "text-xs mt-2" }, "Check console for details or verify your API Key.")
                                )
                            ),
                            data.data.length > 0 && !data.loading && (
                                createElement('canvas', { ref: canvasRef, className: "w-full h-full" })
                            ),
                            data.data.length === 0 && !data.loading && !data.error && (
                                createElement('div', { className: "text-gray-500 text-center" },
                                    createElement('p', { className: "font-bold" }, "No Chart Data Available"),
                                    createElement('p', { className: "text-sm" }, "The API did not return historical data for this symbol.")
                                )
                            )
                        ),
                        createElement('p', { className: "text-xs text-gray-500 p-2 text-center border-t" },
                            "Chart Data Source: Alpha Vantage (API Key must be configured)"
                        )
                    )
                );
            };

            // --- RENDER ---
            
            if (loading) {
                return (
                    createElement('div', { className: "flex justify-center items-center h-screen bg-gray-50" },
                        createElement('div', { className: "text-indigo-600 animate-spin mr-3" },
                            createElement(TrendingUpIcon, { size: 24 })
                        ),
                        createElement('p', { className: "text-lg font-medium text-gray-700" }, "Loading application...")
                    )
                );
            }

            if (error && !chartData) {
                return (
                    createElement('div', { className: "p-8 max-w-xl mx-auto mt-20 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg shadow-lg" },
                        createElement('p', { className: "font-bold" }, "Application Error"),
                        createElement('p', null, error),
                        createElement('p', { className: "mt-2 text-sm" }, "Please check the console for configuration details.")
                    )
                );
            }

            return (
                createElement('div', { className: "min-h-screen bg-gray-100 p-4 font-sans antialiased" },
                    // Header
                    createElement('header', { className: "flex justify-between items-center p-4 bg-white shadow-md rounded-lg mb-6" },
                        createElement('h1', { className: "text-2xl font-extrabold text-indigo-700 flex items-center" },
                            createElement(DollarSignIcon, { size: 24, className: "w-6 h-6 mr-2" }),
                            "Top 20 Stock Screener"
                        ),
                        createElement('div', { className: "text-sm text-gray-600 flex items-center" },
                            createElement(LogInIcon, { size: 20, className: "w-4 h-4 mr-1 text-green-500" }),
                            "Logged in as: ",
                            createElement('span', { className: "font-mono text-xs ml-1 text-gray-800 break-all" }, userId)
                        )
                    ),

                    // Main Content
                    createElement('main', { className: "max-w-4xl mx-auto" },
                        createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                            createElement('h2', { className: "text-xl font-semibold mb-4 text-indigo-600 border-b pb-2" },
                                "Top 20 Calculated Picks"
                            ),
                            
                            topStocks.length === 0 ? (
                                createElement('p', { className: "text-gray-500 italic p-4 text-center" },
                                    "No scored stocks available. Ensure your daily GitHub Action run finished successfully and check the Firestore path."
                                )
                            ) : (
                                createElement('div', { className: "overflow-x-auto rounded-lg border border-gray-200" },
                                    createElement('table', { className: "min-w-full divide-y divide-gray-200" },
                                        createElement('thead', { className: "bg-gray-50" },
                                            createElement('tr', null,
                                                createElement('th', { className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, "Symbol"),
                                                createElement('th', { className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, "P/E Ratio"),
                                                createElement('th', { className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, "Sentiment Score"),
                                                createElement('th', { className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, "Volume Surge"),
                                                createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, "Rank Score"),
                                                createElement('th', { className: "relative px-6 py-3" }, createElement('span', { className: "sr-only" }, "Action"))
                                            )
                                        ),
                                        createElement('tbody', { className: "bg-white divide-y divide-gray-200" },
                                            topStocks.slice(0, 20).map((stock, index) => (
                                                createElement('tr', { key: stock.id, className: "hover:bg-indigo-50 transition duration-150" },
                                                    createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600" },
                                                        createElement('span', { className: "font-bold mr-2 text-gray-500" }, `${index + 1}.`),
                                                        stock.symbol || 'N/A'
                                                    ),
                                                    createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900" }, stock.pe ? stock.pe.toFixed(1) : '—'),
                                                    createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900" }, stock.sentiment ? stock.sentiment.toFixed(2) : '—'),
                                                    createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900" }, stock.volumeSurge ? `${stock.volumeSurge.toFixed(1)}x` : '—'),
                                                    createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm font-bold text-right text-green-700" }, stock.score ? stock.score.toFixed(3) : '0.000'),
                                                    createElement('td', { className: "px-6 py-4 whitespace-nowrap text-right text-sm font-medium" },
                                                        createElement('button', {
                                                            onClick: () => fetchStockData(stock.symbol),
                                                            className: "inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors"
                                                        }, "View Chart")
                                                    )
                                                )
                                            ))
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    // Chart Modal
                    chartData && createElement(ChartModal, { data: chartData, onClose: () => setChartData(null) }),

                    // Backdrop to close modal
                    chartData && createElement('div', { 
                        className: "fixed inset-0 bg-black/10 z-40",
                        onClick: () => setChartData(null)
                    })
                )
            );
        };
        
        // Render the App component into the root element
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // WAIT for Firebase to load before running App logic
                await loadFirebaseSdk();

                const rootElement = document.getElementById('root');
                if (rootElement) {
                    // FIX: Use modern React 18 createRoot API 
                    const root = ReactDOM.createRoot(rootElement);
                    // FIX: Pass the App component directly to the render function.
                    root.render(createElement(App, null));
                }
            } catch (e) {
                console.error("Critical error during application initialization:", e);
                const rootElement = document.getElementById('root');
                if (rootElement) {
                     rootElement.innerHTML = '<div style="padding: 20px; color: red;">FATAL ERROR: Could not load essential scripts (Firebase/React). Check network connection or console for details.</div>';
                }
            }
        });
    </script>
</body>
</html>
